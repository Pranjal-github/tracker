<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{})}</script>

    <title>JEE Ultimate Tracker Pro</title>
    <style>
        :root {
            /* Light Theme Variables */
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --header-text: #ffffff;
            --text: #2b2d42;
            --text-light: #8d99ae;
            --border: #e0e0e0;
            --phy: #480ca8;
            --math: #b5179e;
            --chem: #007200;
            --topic-bg: #f8f9fa;
            --star: #f1c40f;
            --danger: #e74c3c;
        }

        [data-theme="dark"] {
            /* Dark Theme Variables */
            --bg: #0b0e14;
            --card-bg: #1a1f29;
            --text: #e0e0e0;
            --text-light: #a0a0a0;
            --border: #2d343f;
            --topic-bg: #12161d;
            --header-text: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 80px;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--header-text);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        h1 { font-size: 2.2rem; margin-bottom: 0.5rem; letter-spacing: 1px; }
        .quote { font-style: italic; opacity: 0.9; font-size: 0.9rem; margin-bottom: 20px; }

        .progress-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 5px;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--success);
            border-radius: 20px;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- Tools Bar --- */
        .controls-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .tool-card {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border);
        }

        .dot { width: 12px; height: 12px; display: inline-block; border-radius: 2px; }
        .dot.green { background: #2ecc71; }
        .dot.blue { background: #3498db; }
        .dot.orange { background: #e67e22; }

        .btn-small {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* --- Tabs --- */
        .tabs-wrapper {
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 10px;
            scrollbar-width: none;
        }
        .tabs { display: flex; justify-content: center; margin-top: 10px; gap: 10px; min-width: max-content; }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: var(--card-bg);
            color: var(--text);
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            opacity: 0.6;
            transition: all 0.2s;
        }
        .tab-btn.active { opacity: 1; color: white; transform: translateY(-2px); }
        .tab-btn[data-subject="physics"].active { background: var(--phy); }
        .tab-btn[data-subject="chemistry"].active { background: var(--chem); }
        .tab-btn[data-subject="maths"].active { background: var(--math); }
        .tab-btn[data-subject="notebook"].active { background: #f39c12; }
        .tab-btn[data-subject="tasks"].active { background: #e74c3c; }
        .tab-btn[data-subject="tests"].active { background: #2c3e50; }

        /* --- Content Layout --- */
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .subject-section { display: none; }
        .subject-section.active { display: block; animation: fadeIn 0.3s; }

        .chem-category-title {
            color: var(--chem);
            margin: 25px 0 10px;
            padding-left: 10px;
            border-left: 4px solid var(--chem);
        }

        /* --- Chapter Cards --- */
        .chapter-card {
            background: var(--card-bg);
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .chapter-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        .chapter-header:hover { background: rgba(0,0,0,0.02); }

        .header-left { display: flex; align-items: center; gap: 10px; }
        .star-btn {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light); transition: 0.2s;
        }
        .star-btn.active { color: var(--star); transform: scale(1.2); }

        .chapter-title { font-weight: 600; font-size: 1.05rem; }

        .chapter-tools { display: flex; align-items: center; gap: 10px; }
        .todo-add-btn {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text);
        }
        .todo-add-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .check-group { display: flex; gap: 5px; }
        /* Keeping generic chapter tracking as "Overall Status" */
        .custom-check {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }
        .custom-check.c1:checked { background: #2ecc71; border-color: #2ecc71; }
        .custom-check.c2:checked { background: #3498db; border-color: #3498db; }
        .custom-check.c3:checked { background: #e67e22; border-color: #e67e22; }

        /* --- New Topic Row Styles --- */
        .topics-list {
            display: none;
            background: var(--topic-bg);
            padding: 10px 20px;
            border-top: 1px solid var(--border);
        }

        .topic-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.9rem;
        }
        .topic-name { flex: 1; padding-right: 10px; color: var(--text); }

        .topic-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .t-check-label { font-size: 0.7rem; color: var(--text-light); display: flex; flex-direction: column; align-items: center; }
        .rev-counter-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            min-width: 60px;
            text-align: center;
        }
        .rev-counter-btn:active { transform: scale(0.95); }

        .add-area { display: flex; gap: 8px; margin-top: 15px; }
        .add-input {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
        }
        .add-btn {
            background: var(--text);
            color: var(--card-bg);
            border: none;
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* --- Test Tracker Styles --- */
        .test-input-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-group input { padding: 8px; border-radius: 6px; border: 1px solid var(--border); flex: 1; background: var(--bg); color: var(--text); }

        .test-history-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .score-pill {
            display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color: white;
        }
        .score-p { background: var(--phy); }
        .score-c { background: var(--chem); }
        .score-m { background: var(--math); }

        /* --- Task List Styles --- */
        .task-item {
            background: var(--card-bg);
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .task-meta { font-size: 0.75rem; color: var(--primary); background: rgba(67, 97, 238, 0.1); padding: 2px 6px; border-radius: 4px; margin-right: 8px;}

        .backup-zone {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed var(--border);
            text-align: center;
        }
        #todo-list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .todo-group {
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .todo-group-header {
            background: rgba(0,0,0,0.05);
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }

        /* Modern Circular Checkbox (To-Do Style) */
        .modern-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-radius: 50%; /* Circular like the screenshot */
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .modern-checkbox:checked {
            background: var(--primary);
        }
        .modern-checkbox:checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            font-size: 12px;
            left: 4px;
            top: 0px;
        }

        /* Modern Revision Pill */
        .rev-pill {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .rev-pill:hover { background: var(--primary); color: white; }

        /* Clean Todo Layout (Screenshot Style) */
        .todo-group {
            background: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .todo-group-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.02);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-weight: 700;
        }
        .hidden { display: none; }

        @keyframes highlight-fade {
            0% { background-color: rgba(76, 201, 240, 0.3); }
            100% { background-color: var(--card-bg); }
        }

        .highlight-pick {
            animation: highlight-fade 3s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #file-input { display: none; }
    </style>
</head>
<body data-theme="light">

<header>
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
    <h1>JEE TRACKER PRO</h1>
    <div class="quote" id="quote-display">"Loading motivation..."</div>

    <div class="progress-container">
        <div class="progress-bar" id="global-progress"></div>
    </div>
    <div style="margin-top:8px; font-size: 0.8rem;" id="stats-text">0% Done</div>
</header>

<div class="controls-bar">

    <div class="tool-card">
        <button class="btn-small" onclick="pickRandomRevision()" style="background:var(--success); color:white;">üîÄ Pick Topics for Me</button>
    </div>

    <div class="tool-card">
        ‚è± <span id="timer-display">25:00</span>
        <button class="btn-small" onclick="toggleTimer()">Start/Stop</button>
        <button class="btn-small" onclick="resetTimer()" style="background:var(--text-light)">Reset</button>
    </div>

    <div class="tool-card">
        üíæ Data:
        <button class="btn-small" onclick="exportData()" style="background:#27ae60">Export</button>
        <button class="btn-small" onclick="document.getElementById('file-input').click()" style="background:#f39c12">Import</button>
        <input type="file" id="file-input" accept=".json" onchange="importData(event)">
    </div>
</div>

<div class="tabs-wrapper">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('physics')" data-subject="physics">Physics</button>
        <button class="tab-btn" onclick="switchTab('chemistry')" data-subject="chemistry">Chemistry</button>
        <button class="tab-btn" onclick="switchTab('maths')" data-subject="maths">Maths</button>
        <button class="tab-btn" onclick="switchTab('notebook')" data-subject="notebook">‚òÖ Notebook</button>
        <button class="tab-btn" onclick="switchTab('tasks')" data-subject="tasks">‚úì Tasks</button>
        <button class="tab-btn" onclick="switchTab('tests')" data-subject="tests">üìä Tests</button>
    </div>
</div>

<div class="container">
    <div id="physics-content" class="subject-section active"></div>
    <div id="chemistry-content" class="subject-section"></div>
    <div id="maths-content" class="subject-section"></div>

    <div id="notebook-content" class="subject-section">
        <div style="text-align:center; padding: 20px; color: var(--text-light);">
            <h3>Starred Chapters & Topics</h3>
            <p>Click the Star icon on chapters to add them here.</p>
        </div>
        <div id="starred-list"></div>
    </div>

    <div id="tasks-content" class="subject-section">
        <div class="test-input-card">
            <div class="input-group">
                <input type="text" id="new-task-input" placeholder="Add a general task...">
                <button class="btn-small" onclick="addTaskManual()">Add</button>
            </div>
        </div>
        <div id="todo-list-container"></div>
    </div>

    <div id="tests-content" class="subject-section">
        <div class="test-input-card">
            <h3>Add Test Score</h3>
            <div class="input-group">
                <input type="text" id="test-name" placeholder="Test Name (e.g. Mock 1)">
                <input type="date" id="test-date">
            </div>
            <div class="input-group">
                <input type="number" id="score-p" placeholder="Physics Score">
                <input type="number" id="score-c" placeholder="Chem Score">
                <input type="number" id="score-m" placeholder="Math Score">
                <input type="number" id="score-total-max" placeholder="Max Marks (e.g. 300)" value="300">
            </div>
            <button class="btn-small" style="width:100%" onclick="addTestScore()">Save Score</button>
        </div>
        <div id="test-history"></div>
    </div>

    <div class="backup-zone">
        <button class="btn-small" style="background:#e74c3c" onclick="resetAllData()">Delete All Progress</button>
    </div>
</div>

<script>
    // --- Initial Data ---
const defaultData = {
    physics: {
            "General": [
                { "name": "Units and Measurements", "topics": ["SI base and derived units", "Fundamental and derived units", "Dimensions of physical quantities", "Dimensional analysis and applications", "Significant figures and least count", "Error estimation and propagation"] },
                { "name": "Kinematics", "topics": ["Position, displacement, speed, velocity, acceleration", "Motion in one dimension (uniform and uniformly accelerated)", "Velocity‚Äìtime and displacement‚Äìtime graphs", "Motion in two dimensions", "Projectile motion", "Relative velocity", "Uniform circular motion", "Frames of reference (inertial vs non-inertial, qualitative)"] },
                { "name": "Laws of Motion", "topics": ["Newton's three laws of motion", "Concept of force, mass and inertia", "Free body diagrams", "Friction (static and kinetic)", "Applications (incl. pulley systems, inclined plane, connected bodies)", "Impulse and momentum", "Conservation of linear momentum (1D and 2D collisions)", "Center of mass and motion of center of mass"] },
                { "name": "Work, Energy and Power", "topics": ["Work done by constant and variable forces", "Kinetic and potential energy", "Work‚Äìenergy theorem", "Conservation of mechanical energy", "Power", "Potential energy of elastic systems (springs)", "Energy in collisions and circular motion (qualitative and quantitative)"] },
                { "name": "Rotational Motion", "topics": ["Angular displacement, velocity, acceleration", "Relation between linear and angular quantities", "Torque and moment of force", "Moment of inertia (calculation for common bodies)", "Parallel axis and perpendicular axis theorems", "Angular momentum and its conservation", "Rotational kinetic energy", "Rolling without slipping, energy of rolling bodies"] },
                { "name": "Gravitation", "topics": ["Newton's law of gravitation", "Gravitational field and potential", "Acceleration due to gravity and its variation with altitude and depth", "Kepler's laws of planetary motion", "Orbital motion and satellites", "Escape velocity", "Gravitational potential energy of systems"] },
                { "name": "Properties of Solids and Liquids", "topics": ["Elastic behavior: stress, strain, Hooke's law", "Young's modulus, bulk modulus, shear modulus", "Pressure in a fluid, Pascal's law", "Buoyancy and Archimedes' principle", "Viscosity (qualitative, Stokes' law, terminal velocity)", "Surface tension, capillarity, drop and bubble phenomena", "Flow of fluids, Bernoulli's principle (applications)"] },
                { "name": "Oscillations and Waves", "topics": ["Simple harmonic motion (SHM): time period, frequency, amplitude", "Energy in SHM (kinetic and potential)", "Damped and forced oscillations (qualitative)", "Resonance and beats", "Wave motion: transverse and longitudinal waves", "Superposition principle", "Standing waves on strings and in pipes", "Wave speed, frequency, wavelength, phase"] },
                { "name": "Electrostatics", "topics": ["Electric charge, conservation of charge", "Coulomb's law for point charges", "Electric field and field lines", "Electric field due to point charge, dipole, system of charges", "Electric flux and Gauss's law (symmetry applications)", "Electric potential and potential difference", "Electric potential due to point charge and dipole", "Equipotential surfaces, potential energy of charge systems", "Conductors, insulators, dielectrics, polarization", "Capacitance, parallel plate capacitor, capacitors in series and parallel"] },
                { "name": "Current Electricity", "topics": ["Electric current and drift velocity", "Ohm's law, resistivity and resistance", "Temperature dependence of resistance", "Series and parallel circuits", "Kirchhoff's laws and circuit analysis", "Internal resistance of cells and EMF", "Wheatstone bridge and meter bridge", "Electrical energy and power"] },
                { "name": "Magnetism and Electromagnetism", "topics": ["Magnetic field and magnetic field lines", "Biot‚ÄìSavart law (qualitative) and field due to current elements", "Amp√®re's circuital law (applications)", "Force on a moving charge and on a current-carrying conductor (Lorentz force)", "Magnetic dipole and magnetic moment", "Moving coil galvanometer and conversion to ammeter/voltmeter", "Magnetic materials: diamagnetic, paramagnetic, ferromagnetic (qualitative)", "Electromagnetic induction: Faraday's law and Lenz's law", "Self and mutual inductance, LR circuits"] },
                { "name": "Electromagnetic Waves and Optics", "topics": ["Displacement current and Maxwell's equations (conceptual)", "Electromagnetic spectrum and properties of EM waves", "Reflection and refraction at plane and spherical surfaces", "Lens formula, magnification, combinations of lenses", "Total internal reflection and optical fibers (qualitative)", "Wave optics: Huygens' principle, interference (Young's double slit)", "Diffraction (single slit, qualitative), resolution", "Polarization of light (qualitative)"] },
                { "name": "Modern Physics", "topics": ["Photoelectric effect and Einstein's explanation", "Dual nature of matter and radiation (de Broglie wavelength)", "Bohr model of hydrogen atom and spectral lines (qualitative)", "X-rays: production and properties (qualitative)", "Radioactivity: Œ±, Œ≤, Œ≥ decay, half-life and decay law", "Nuclear binding energy, mass defect, fission and fusion (conceptual)", "Basics of semiconductors, PN junctions, diodes (qualitative)"] }
            ]
        },
        maths: {
            "Algebra": [
                { "name": "Sets, Relations and Functions", "topics": ["Sets and set operations", "Power set", "Relations (equivalence, order)", "Functions: one-one, onto, composite, inverse", "Types of functions: polynomial, rational, trigonometric, exponential, logarithmic, modulus, floor/ceiling"] },
                { "name": "Complex Numbers & Quadratic Equations", "topics": ["Algebra of complex numbers", "Argand plane, modulus and argument", "Polar form and De Moivre's theorem", "Roots of complex numbers and nth roots of unity", "Quadratic equations: nature of roots, relationship between roots and coefficients"] },
                { "name": "Matrices and Determinants", "topics": ["Definition and types of matrices", "Matrix operations: addition, multiplication, transpose", "Determinants (2√ó2, 3√ó3), properties of determinants", "Inverse of a matrix and adjoint", "Solution of linear systems: Cramer's rule, matrix method"] },
                { "name": "Permutations and Combinations", "topics": ["Fundamental principle of counting", "Permutations P(n,r) with and without repetition", "Combinations C(n,r) and properties", "Simple applications and problems"] },
                { "name": "Binomial Theorem", "topics": ["Binomial expansion for positive integer exponents", "General term in binomial expansion", "Middle term and properties of binomial coefficients"] },
                { "name": "Sequence & Series", "topics": ["Arithmetic progression (AP): n-th term, sum", "Geometric progression (GP): n-th term, sum, infinite GP (|r|<1)", "Harmonic progression (HP) basics", "Arithmetic‚Äìgeometric series, sum tricks"] },
                { "name": "Limits, Continuity and Differentiability", "topics": ["Limits of functions and standard limits", "Continuity and types of discontinuities", "Differentiability and derivative rules", "Chain rule, product and quotient rules", "Implicit differentiation", "Higher order derivatives (up to second order)", "Applications: tangents, normals, maxima and minima"] },
                { "name": "Integral Calculus", "topics": ["Indefinite integrals and standard formulas", "Definite integrals and properties", "Fundamental theorem of calculus", "Methods of integration: substitution, integration by parts, partial fractions, trigonometric integrals", "Applications: area under curve, area between curves"] },
                { "name": "Differential Equations", "topics": ["Formation of ordinary differential equations (ODEs)", "First order ODEs: separable and homogeneous types", "Linear first order ODEs and simple higher order ODEs (basic)"] },
                { "name": "Coordinate Geometry", "topics": ["Straight lines: various forms, slope, intercepts, distance from point to line", "Circles: center, radius, general equation", "Conic sections: parabola, ellipse, hyperbola ‚Äì standard forms and properties", "Pair of straight lines, locus problems", "3D geometry: coordinates in space, distance between points, direction cosines/ratios, equation of lines and planes, angle/shortest distance between skew lines"] },
                { "name": "Vector Algebra", "topics": ["Representation of vectors in 2D and 3D", "Vector addition and scalar multiplication", "Dot (scalar) product and cross (vector) product", "Scalar triple product and applications", "Vector equations of lines and planes (basic use)"] },
                { "name": "Statistics and Probability", "topics": ["Measures of central tendency: mean, median, mode", "Measures of dispersion: variance, standard deviation", "Probability axioms and basic probability rules", "Conditional probability and Bayes' theorem", "Elementary probability distributions and expected value"] },
                { "name": "Trigonometry", "topics": ["Trigonometric ratios and identities", "Graphs of trigonometric functions", "Inverse trigonometric functions", "Addition and subtraction formulas", "Multiple and submultiple angle formulas", "Solution of trigonometric equations"] }
            ]
        },
        chemistry: {
            "Physical": [
                { "name": "Basic Concepts", "topics": ["Matter and atomic theory", "Mole concept and stoichiometry", "Mole fraction, molarity, molality, normality", "Gas laws: ideal gas equation, van der Waals equation", "Kinetic theory of gases", "Intermolecular forces: types and effects", "Properties of liquids: vapor pressure, surface tension, viscosity"] },
                { "name": "Atomic Structure", "topics": ["Bohr model of hydrogen atom (qualitative)", "Atomic spectra", "De Broglie concept and wave nature", "Quantum numbers and orbitals (s, p, d)", "Aufbau principle, Pauli exclusion principle, Hund's rule"] },
                { "name": "Chemical Bonding and Molecular Structure", "topics": ["Ionic and covalent bonding", "Lewis structures and octet rule", "Fajan's rules", "Lattice enthalpy (qualitative)", "VSEPR theory and molecular shapes", "Hybridization (sp, sp2, sp3, dsp2, d2sp3)", "Resonance and molecular orbital concepts (basic)"] },
                { "name": "Chemical Thermodynamics", "topics": ["First law of thermodynamics: work, heat, internal energy, enthalpy", "Hess's law", "Bond dissociation enthalpies (qualitative)", "Second law of thermodynamics: entropy and spontaneity", "Gibbs free energy and relation to equilibrium"] },
                { "name": "Chemical and Ionic Equilibrium", "topics": ["Law of mass action", "Equilibrium constants Kc, Kp", "Le Chatelier's principle", "Common ion effect and solubility product", "Acid‚Äìbase concepts, pH and buffers (qualitative)"] },
                { "name": "Electrochemistry", "topics": ["Conductance in electrolytic solutions", "Kohlrausch's law (qualitative)", "Galvanic and electrolytic cells", "Standard electrode potentials", "Nernst equation", "Relation between EMF and ŒîG", "Faraday's laws of electrolysis, batteries"] },
                { "name": "Chemical Kinetics", "topics": ["Rate of a reaction and rate law", "Order and molecularity", "Integrated rate equations for zero and first order", "Half-life concept", "Temperature dependence of rate constant (Arrhenius equation)", "Activation energy (qualitative), collision theory"] },
                { "name": "Solutions", "topics": ["Ideal and non-ideal solutions (Raoult's law)", "Vapor pressure lowering and deviations", "Colligative properties: boiling point elevation, freezing point depression, osmotic pressure", "Van't Hoff factor and its effect"] },
                { "name": "Surface Chemistry", "topics": ["Adsorption: physisorption vs chemisorption, adsorption isotherms (Freundlich)", "Catalysis: homogeneous and heterogeneous catalysts (conceptual)", "Colloids: types, preparation and properties", "Emulsions, surfactants and micelles (conceptual)"] },
                { "name": "Solid State", "topics": ["Classification of solids: crystalline and amorphous", "Crystal lattices and unit cells (SC, BCC, FCC, HCP)", "Packing efficiency and density calculations", "Point defects and their effects", "Ionic radii and radius ratio rules"] }
            ],
            "Inorganic": [
                { "name": "Classification and Periodicity", "topics": ["Modern periodic law and long-form periodic table", "Electronic configurations of elements", "Periodic trends: atomic/ionic radii, ionization enthalpy, electron affinity, electronegativity", "Valency and oxidation states", "Block-wise classification (s, p, d, f)"] },
                { "name": "Hydrogen", "topics": ["Position of hydrogen in periodic table and isotopes", "Preparation and properties of hydrogen", "Hydrides: ionic, covalent and interstitial", "Properties of water and heavy water", "Hydrogen peroxide: preparation and reactions (qualitative)"] },
                { "name": "s-Block Elements", "topics": ["General trends in Group 1 and Group 2", "Electronic configuration and reactivity", "Anomalous behavior of Li and Be", "Important compounds: oxides, hydroxides, carbonates, halides, nitrates", "Extraction and uses (basic)"] },
                { "name": "p-Block Elements", "topics": ["Group 13: boron and aluminum ‚Äì properties and important compounds (borax, BF3, AlCl3)", "Group 14: carbon (allotropes), silicon and its oxides and silicates", "Group 15: nitrogen and phosphorus ‚Äì oxides, hydrides, important compounds", "Group 16: oxygen and sulfur ‚Äì oxides, oxoacids and allotropes", "Group 17: halogens ‚Äì chemistry of Cl2, Br2, I2; acids and oxoacids of halogens", "Group 18: noble gases ‚Äì inertness and xenon compounds (qualitative)"] },
                { "name": "d-Block Elements (Transition Metals)", "topics": ["General electronic configuration and characteristic properties", "Variable oxidation states, color of compounds, catalytic behavior", "Magnetic properties (qualitative), formation of complexes", "Important reagents and compounds (e.g., KMnO4, K2Cr2O7)"] },
                { "name": "f-Block Elements", "topics": ["General electronic configuration, oxidation states", "Lanthanoid contraction and its consequences", "Basic chemistry of lanthanoids and actinoids (qualitative)"] },
                { "name": "Coordination Compounds", "topics": ["Werner's coordination theory", "Nomenclature of coordination compounds", "Ligands, coordination number and types", "Isomerism in coordination complexes (structural, stereoisomerism)", "Basic bonding ideas: valence bond and qualitative crystal field concepts", "Spectrochemical series and magnetic properties (spin concepts)"] },
                { "name": "Metallurgy and Isolation of Metals", "topics": ["Ore concentration methods", "Principles of extraction of metals from concentrated ores (thermodynamic and electrolytic processes)", "Refining methods and metallurgy of common metals (Fe, Cu, Al)", "Important processes: cyanide process for gold and silver (qualitative)"] },
                { "name": "Qualitative Inorganic Analysis", "topics": ["Analysis of common cations: group separation (Ag+, Pb2+, Cu2+, Fe3+, Al3+, Ca2+, Ba2+, Zn2+, Mn2+, Mg2+ etc.)", "Confirmatory tests for cations", "Common anions: CO3(2-), SO4(2-), NO3(-), Cl(-), Br(-), I(-), S(2-) and their tests (qualitative)"] },
                { "name": "Environmental Chemistry", "topics": ["Air pollution: major pollutants and their effects (CO, CO2, NOx, SOx, particulate matter)", "Water pollution: sources, heavy metals, fluorides, eutrophication", "Soil pollution and remediation concepts", "Green chemistry principles and pollution control strategies"] }
            ],
            "Organic": [
                { "name": "Basic Principles of Organic Chemistry", "topics": ["Tetravalency and hybridization of carbon (sp, sp2, sp3)", "Shapes of simple organic molecules", "Identification and classification by functional groups", "Homologous series and IUPAC nomenclature", "Isomerism: structural, geometrical (cis/trans), optical (qualitative)", "Electronic effects: inductive, resonance, hyperconjugation", "Reaction types: substitution, addition, elimination, rearrangement, radical reactions"] },
                { "name": "Hydrocarbons", "topics": ["Alkanes: nomenclature, conformations (Newman projections), methods of preparation, properties", "Free radical halogenation of alkanes (mechanism)", "Alkenes: structure, geometry, electrophilic addition reactions, Markovnikov rule, anti-Markovnikov (peroxide effect), polymerization, ozonolysis", "Alkynes: acidity, addition reactions, preparation and reactions", "Aromatic hydrocarbons: benzene structure and aromaticity, electrophilic aromatic substitution (nitration, halogenation, Friedel‚ÄìCrafts reactions), directing effects of substituents"] },
                { "name": "Organic Compounds Containing Halogens", "topics": ["Alkyl and aryl halides: nomenclature and bonding", "Preparation methods", "Nucleophilic substitution reactions: SN1 and SN2 mechanisms", "Reactivity differences between alkyl and aryl halides", "Environmental and application notes (qualitative)"] },
                { "name": "Organic Compounds Containing Oxygen", "topics": ["Alcohols: classification (1¬∞, 2¬∞, 3¬∞), preparation, reactions (dehydration, oxidation, substitution), acidic character", "Phenols: acidity, electrophilic substitution reactions, Reimer‚ÄìTiemann and Kolbe reactions", "Ethers: Williamson synthesis, cleavage reactions", "Aldehydes and Ketones: nucleophilic addition reactions, formation of imines/oximes, Cannizzaro reaction, aldol condensation, reductions (NaBH4, LiAlH4)", "Carboxylic Acids and Derivatives: acidity, preparation, conversions to esters, acid chlorides, amides"] },
                { "name": "Organic Compounds Containing Nitrogen", "topics": ["Amines: classification, basicity, methods of preparation (Gabriel synth., Hoffmann degradation), reactions and diazotization", "Diazonium salts: formation and synthetic applications (Sandmeyer, coupling reactions)", "Important nitrogen containing functional groups and reactivity"] },
                { "name": "Purification and Characterization", "topics": ["Purification techniques: crystallization, distillation, sublimation, extraction, chromatography (principles)", "Qualitative elemental detection (N, S, halogens)", "Determination of empirical and molecular formula (conceptual)"] },
                { "name": "Biomolecules, Polymers and Practical Organic Chemistry", "topics": ["Carbohydrates: classification, structure of glucose and fructose, glycosidic bonds", "Amino acids and proteins: peptide bond and primary structure (qualitative), denaturation", "Nucleic acids: basic structure of DNA and RNA (qualitative)", "Polymers: addition and condensation polymerization, examples (polyethylene, nylon, Teflon, PVC, biodegradable polymers)", "Soaps and detergents: structure and cleansing action", "Practical tests for functional groups and simple titrations (qualitative understanding)"] }
            ]
        }
};

    let syllabus = {};
    let progressState = {}; // Stores checkboxes, revision counts, stars
    let tasks = [];
    let tests = [];

    // --- Core Logic ---
    function init() {
        // Theme Load
        setTheme(localStorage.getItem('jee_theme') || 'light');

        // Data Load
        const savedSyllabus = localStorage.getItem('jee_syllabus_struct');
        syllabus = savedSyllabus ? JSON.parse(savedSyllabus) : JSON.parse(JSON.stringify(defaultData));

        const savedProgress = localStorage.getItem('jee_progress_state');
        progressState = savedProgress ? JSON.parse(savedProgress) : {};

        const savedTasks = localStorage.getItem('jee_tasks');
        tasks = savedTasks ? JSON.parse(savedTasks) : [];

        const savedTests = localStorage.getItem('jee_tests');
        tests = savedTests ? JSON.parse(savedTests) : [];

        renderAll();
        updateGlobalStats();
        randomQuote();
    }

    function saveToLocal() {
        localStorage.setItem('jee_syllabus_struct', JSON.stringify(syllabus));
        localStorage.setItem('jee_progress_state', JSON.stringify(progressState));
        localStorage.setItem('jee_tasks', JSON.stringify(tasks));
        localStorage.setItem('jee_tests', JSON.stringify(tests));
        updateGlobalStats();
    }

    // --- Rendering ---
    function renderAll() {
        renderSubject('physics', 'physics-content');
        renderSubject('maths', 'maths-content');
        renderChemistry();
        renderNotebook();
        renderTasks();
        renderTests();
    }

    function renderSubject(subjKey, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        for (const [category, chapters] of Object.entries(syllabus[subjKey])) {
            // Category Header if needed, skipping for simple subjects
            chapters.forEach((chapter, index) => {
                const uniqueId = `${subjKey}-${category}-${index}`.replace(/\s+/g, '-');
                container.appendChild(createChapterCard(chapter, uniqueId, subjKey, category, index));
            });
            container.appendChild(createAddChapterUI(subjKey, category));
        }
    }

    function renderChemistry() {
        const container = document.getElementById('chemistry-content');
        container.innerHTML = "";
        ["Physical", "Inorganic", "Organic"].forEach(cat => {
            const header = document.createElement('h3');
            header.className = "chem-category-title";
            header.innerText = cat;
            container.appendChild(header);

            if(syllabus.chemistry[cat]) {
                syllabus.chemistry[cat].forEach((chapter, index) => {
                    const uniqueId = `chemistry-${cat}-${index}`.replace(/\s+/g, '-');
                    container.appendChild(createChapterCard(chapter, uniqueId, 'chemistry', cat, index));
                });
                container.appendChild(createAddChapterUI('chemistry', cat));
            }
        });
    }

    function createChapterCard(chapter, id, subject, category, index) {
        const card = document.createElement('div');
        card.className = "chapter-card";

        // State Keys
        const starKey = `star-${id}`;
        const isStarred = progressState[starKey] || false;

        // Chapter Level Legacy Checkboxes
        const c1 = `${id}-c1`, c2 = `${id}-c2`, c3 = `${id}-c3`;

        card.innerHTML = `
            <div class="chapter-header" onclick="toggleTopics('${id}')">
                <div class="header-left">
                    <button class="star-btn ${isStarred ? 'active' : ''}" onclick="toggleStar(event, '${id}')">‚òÖ</button>
                    <span class="chapter-title">${chapter.name}</span>
                </div>

                <div class="chapter-tools" onclick="event.stopPropagation()">
                    <button class="todo-add-btn" onclick="addTodoFromChapter('${chapter.name}')">+ Todo</button>
                    <div class="check-group">
                        <input type="checkbox" title="Theory Done" class="custom-check c1" ${progressState[c1]?'checked':''} onchange="updateCheck('${c1}', this)">
                        <input type="checkbox" title="Notes Revised" class="custom-check c2" ${progressState[c2]?'checked':''} onchange="updateCheck('${c2}', this)">
                        <input type="checkbox" title="PYQs Done" class="custom-check c3" ${progressState[c3]?'checked':''} onchange="updateCheck('${c3}', this)">
                    </div>
                </div>
            </div>

            <div class="topics-list" id="topics-${id}">
                ${chapter.topics.map((t, tIdx) => createTopicRow(t, id, tIdx)).join('')}
                <div class="add-area">
                    <input type="text" class="add-input" placeholder="New topic..." id="in-${id}">
                    <button class="add-btn" onclick="addTopic('${subject}','${category}',${index},'${id}')">+</button>
                </div>
            </div>`;
        return card;
    }

    function createTopicRow(topicName, chapterId, topicIndex) {
        // Unique keys for topic state
        const doneKey = `t-done-${chapterId}-${topicIndex}`;
        const revKey = `t-rev-${chapterId}-${topicIndex}`;
        const qsKey = `t-qs-${chapterId}-${topicIndex}`;

        const isDone = progressState[doneKey] || false;
        const revCount = progressState[revKey] || 0;
        const isQs = progressState[qsKey] || false;

        return `
        <div class="topic-row">
            <span class="topic-name">${topicName}</span>
            <div class="topic-controls">
                <button class="todo-add-btn" onclick="addTodoFromTopic('${topicName}', '${chapterId}')" title="Add to Tasks">+</button>

                <label class="t-check-label">
                    <input type="checkbox" class="modern-checkbox" ${isDone?'checked':''} onchange="updateTopicState('${doneKey}', this.checked)"> Done
                </label>

                <button class="rev-pill" onclick="incrementRev('${revKey}', this)">
                    Rev: ${revCount}
                </button>

                <label class="t-check-label">
                    <input type="checkbox" class="modern-checkbox" ${isQs?'checked':''} onchange="updateTopicState('${qsKey}', this.checked)"> Qs
                </label>
            </div>
        </div>
        `;
    }

    function createAddChapterUI(sub, cat) {
        const div = document.createElement('div');
        div.className = "add-area";
        div.style.padding = "0 10px 20px 10px";
        div.innerHTML = `
            <input type="text" class="add-input" placeholder="Add Chapter to ${cat}..." id="new-${sub}-${cat}">
            <button class="add-btn" onclick="addNewChapter('${sub}','${cat}')">Add</button>`;
        return div;
    }

    // --- Action Logic ---
    function toggleTopics(id) {
        const el = document.getElementById(`topics-${id}`);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function toggleStar(e, id) {
        e.stopPropagation();
        const k = `star-${id}`;
        progressState[k] = !progressState[k];
        saveToLocal();
        renderAll(); // Re-render to update Star UI and Notebook
    }

    function updateCheck(id, el) {
        progressState[id] = el.checked;
        saveToLocal();
    }

    function updateTopicState(key, val) {
        progressState[key] = val;
        saveToLocal();
    }

    function incrementRev(key, btn) {
        let val = (progressState[key] || 0) + 1;
        progressState[key] = val;
        btn.innerText = `Rev: ${val}`;
        saveToLocal();
    }

    function addNewChapter(sub, cat) {
        const inputId = `new-${sub}-${cat}`;
        const val = document.getElementById(inputId).value;
        if(!val) return;

        if(!syllabus[sub][cat]) syllabus[sub][cat] = [];
        syllabus[sub][cat].push({ name: val, topics: [] });
        document.getElementById(inputId).value = "";
        saveToLocal(); renderAll();
    }

    function addTopic(sub, cat, idx, uiId) {
        const val = document.getElementById(`in-${uiId}`).value;
        if(!val) return;
        syllabus[sub][cat][idx].topics.push(val);
        saveToLocal(); renderAll();
        document.getElementById(`topics-${uiId}`).style.display = 'block';
    }

    // --- Notebook Logic ---
    function renderNotebook() {
        const container = document.getElementById('starred-list');
        container.innerHTML = "";

        // Scan all chapters for stars
        let found = false;
        const scan = (sub) => {
            const categories = syllabus[sub];
            for(let cat in categories) {
                categories[cat].forEach((chap, idx) => {
                    const id = `${sub}-${cat}-${idx}`.replace(/\s+/g, '-');
                    if(progressState[`star-${id}`]) {
                        found = true;
                        // Clone the card for display, but strip edit/add buttons for cleaner view
                        // Or simply re-use createChapterCard
                        const card = createChapterCard(chap, id, sub, cat, idx);
                        container.appendChild(card);
                    }
                });
            }
        };

        scan('physics'); scan('chemistry'); scan('maths');

        if(!found) container.innerHTML = "<div style='text-align:center;color:var(--text-light)'>No starred chapters yet.</div>";
    }

    // --- Task Logic ---
    function addTodoFromChapter(chapName) {
        const task = { text: `Revise ${chapName}`, tag: chapName, done: false, id: Date.now() };
        tasks.push(task);
        saveToLocal();
        alert(`Added "${task.text}" to Tasks tab`);
        renderTasks();
    }

    function addTodoFromTopic(topicName, chapterId) {
        // Find chapter name for the tag
        const chapTitle = document.querySelector(`#topics-${chapterId}`).previousElementSibling.querySelector('.chapter-title').innerText;
        const task = { text: topicName, tag: chapTitle, done: false, id: Date.now() };
        tasks.push(task);
        saveToLocal();
        alert(`Added topic to tasks!`);
        renderTasks();
    }

    function addTaskManual() {
        const input = document.getElementById('new-task-input');
        if(!input.value) return;
        tasks.push({ text: input.value, tag: 'General', done: false, id: Date.now() });
        input.value = "";
        saveToLocal();
        renderTasks();
    }

    function deleteTask(id) {
        // Convert both to strings to avoid "Large Number" precision errors in JS
        tasks = tasks.filter(t => String(t.id) !== String(id));
        saveToLocal();
        renderTasks();
    }

    function toggleTask(id) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (task) {
            task.done = !task.done;
            saveToLocal();
            renderTasks();
        }
    }

    function renderTasks() {
        const container = document.getElementById('todo-list-container');
        container.innerHTML = "";

        if (tasks.length === 0) {
            container.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No tasks yet.</div>";
            return;
        }

        // Group tasks by their Tag (Chapter Name)
        const grouped = tasks.reduce((acc, t) => {
            if (!acc[t.tag]) acc[t.tag] = [];
            acc[t.tag].push(t);
            return acc;
        }, {});

        for (const [tag, items] of Object.entries(grouped)) {
            const groupDiv = document.createElement('div');
            groupDiv.className = "todo-group";
            groupDiv.innerHTML = `
                <div class="todo-group-header" onclick="this.nextElementSibling.classList.toggle('hidden')">
                    <span style="font-size:0.8rem; margin-right:8px;">üìÇ</span>
                    <span>${tag}</span>
                    <span style="margin-left:auto; font-size:0.75rem; opacity:0.6;">${items.length} items</span>
                </div>
                <div class="todo-items-list">
                    ${items.map(t => `
                        <div class="task-item">
                            <div style="display:flex; align-items:center; gap:12px; flex:1;">
                                <input type="checkbox" class="modern-checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask('${t.id}')">
                                <span style="${t.done ? 'text-decoration:line-through; opacity:0.5' : ''}">${t.text}</span>
                            </div>
                            <button onclick="deleteTask('${t.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.1rem; padding:0 5px;">‚úï</button>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(groupDiv);
        }
    }

    // --- Test Logic ---
    function addTestScore() {
        const name = document.getElementById('test-name').value || "Unknown Test";
        const date = document.getElementById('test-date').value || new Date().toISOString().slice(0,10);
        const p = Number(document.getElementById('score-p').value) || 0;
        const c = Number(document.getElementById('score-c').value) || 0;
        const m = Number(document.getElementById('score-m').value) || 0;
        const max = Number(document.getElementById('score-total-max').value) || 300;

        tests.unshift({ name, date, p, c, m, max }); // Add to top
        saveToLocal();
        renderTests();

        // Clear inputs
        document.getElementById('score-p').value = '';
        document.getElementById('score-c').value = '';
        document.getElementById('score-m').value = '';
    }

    function renderTests() {
        const container = document.getElementById('test-history');
        container.innerHTML = "";

        tests.forEach((t, idx) => {
            const total = t.p + t.c + t.m;
            const perc = Math.round((total / t.max) * 100);

            const div = document.createElement('div');
            div.className = "test-history-item";
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <strong>${t.name}</strong>
                    <span style="font-size:0.8rem; opacity:0.7">${t.date}</span>
                </div>
                <div style="margin-bottom:8px;">
                    <span class="score-pill score-p">P: ${t.p}</span>
                    <span class="score-pill score-c">C: ${t.c}</span>
                    <span class="score-pill score-m">M: ${t.m}</span>
                    <span style="float:right; font-weight:bold;">${total}/${t.max}</span>
                </div>
                <div style="background:rgba(0,0,0,0.1); height:6px; border-radius:3px; overflow:hidden;">
                    <div style="width:${perc}%; background:var(--primary); height:100%;"></div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // --- Utilities ---
    function switchTab(sub) {
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.subject-section').forEach(el => el.classList.remove('active'));

        document.querySelector(`.tab-btn[data-subject="${sub}"]`).classList.add('active');
        document.getElementById(`${sub}-content`).classList.add('active');
    }

    function toggleTheme() {
        const current = document.body.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        setTheme(next);
    }

    function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('jee_theme', theme);
        document.getElementById('theme-btn').innerText = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    function updateGlobalStats() {
        let totalTopics = 0;
        let topicsDone = 0;

        // Use the actual syllabus object instead of 'allTopics'
        Object.keys(syllabus).forEach(subKey => {
            const subject = syllabus[subKey];
            Object.keys(subject).forEach(cat => {
                subject[cat].forEach((chap, cIdx) => {
                    // Ensure the chapId matches the one generated in createTopicRow
                    const chapId = `${subKey}-${cat}-${cIdx}`.replace(/\s+/g, '-');
                    chap.topics.forEach((topic, tIdx) => {
                        totalTopics++;
                        if (progressState[`t-done-${chapId}-${tIdx}`]) {
                            topicsDone++;
                        }
                    });
                });
            });
        });

        const percent = totalTopics ? Math.round((topicsDone / totalTopics) * 100) : 0;

        // Safety check for the elements
        const bar = document.getElementById('global-progress');
        const text = document.getElementById('stats-text');
        if(bar) bar.style.width = percent + '%';
        if(text) text.innerText = `${percent}% Syllabus Completed`;
    }

    // Timer
let timerRunning = false;
let seconds = 1500; // 25 minutes

function toggleTimer() {
    if (timerRunning) {
        clearInterval(timerInt);
        timerRunning = false;
    } else {
        timerRunning = true;
        timerInt = setInterval(() => {
            if (seconds <= 0) {
                clearInterval(timerInt);
                alert("Session complete! Take a break.");
                return;
            }
            seconds--;
            updateTimerDisplay();
        }, 1000);
    }
}

function updateTimerDisplay() {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    document.getElementById('timer-display').innerText =
        `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

// Add a Reset button in your HTML tool-card to call this:
function resetTimer() {
    clearInterval(timerInt);
    timerRunning = false;
    seconds = 1500;
    updateTimerDisplay();
}

    function exportData() {
        const data = { syllabus, progress: progressState, tasks, tests };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `jee_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);

                // Check if it's our format
                if (imported.progressState || imported.syllabus) {
                    // Restore all 4 main data pieces
                    syllabus = imported.syllabus || syllabus;
                    progressState = imported.progressState || imported.progress || {};
                    tasks = imported.tasks || [];
                    tests = imported.tests || [];

                    saveToLocal();
                    alert("Import Successful! Reloading...");
                    location.reload();
                } else {
                    alert("Invalid Backup File!");
                }
            } catch (err) {
                console.error(err);
                alert("Error reading file! Make sure it's a valid JSON.");
            }
        };
        reader.readAsText(file);
    }

    function randomQuote() {
        const q = ["Success is not final, failure is not fatal.", "Don't watch the clock; do what it does.", "Dream big and dare to fail."];
        document.getElementById('quote-display').innerText = q[Math.floor(Math.random()*q.length)];
    }

    function resetAllData() {
        if(confirm("Delete ALL data? This cannot be undone.")) { localStorage.clear(); location.reload(); }
    }
    function resetTimer() {
        if(timerInt) { clearInterval(timerInt); timerInt = null; }
        seconds = 1500; // Resets to 25 mins
        const m = Math.floor(seconds/60), s = seconds%60;
        document.getElementById('timer-display').innerText = `${m}:${s<10?'0':''}${s}`;
    }

    function pickRandomRevision() {
        const completedTopics = [];

        // Loop through all subjects, categories, and chapters
        Object.keys(syllabus).forEach(subKey => {
            const subject = syllabus[subKey];
            Object.keys(subject).forEach(cat => {
                subject[cat].forEach((chap, cIdx) => {
                    const chapId = `${subKey}-${cat}-${cIdx}`.replace(/\s+/g, '-');

                    chap.topics.forEach((topic, tIdx) => {
                        const doneKey = `t-done-${chapId}-${tIdx}`;
                        // Only pick topics that are marked as 'Done'
                        if (progressState[doneKey]) {
                            completedTopics.push({
                                name: topic,
                                subject: subKey,
                                chapterId: chapId,
                                chapterName: chap.name
                            });
                        }
                    });
                });
            });
        });

        if (completedTopics.length === 0) {
            alert("No completed topics found! Mark some topics as 'Done' first.");
            return;
        }

        const pick = completedTopics[Math.floor(Math.random() * completedTopics.length)];

        // 1. Switch to the correct tab (Physics/Chem/Math)
        switchTab(pick.subject);

        // 2. Open the chapter dropdown
        const topicArea = document.getElementById(`topics-${pick.chapterId}`);
        if (topicArea) {
            topicArea.classList.remove('hidden'); // Ensure it's visible
            topicArea.style.display = 'block';

            // 3. Scroll to the chapter and highlight it
            topicArea.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Visual feedback
            topicArea.parentElement.style.outline = "2px solid var(--success)";
            setTimeout(() => {
                topicArea.parentElement.style.outline = "none";
            }, 3000);
        }

        alert(`Time to revise: ${pick.name}\n(Chapter: ${pick.chapterName})`);
    }

    window.onload = init;
</script>

</body>
</html>
